
# å¾®ä¿¡æ‰«ç ç™»å½•åç«¯å¼€å‘è¯¾ä»¶

## è¯¾ç¨‹æ¦‚è¿°

æœ¬è¯¾ç¨‹åŸºäºSpringAI-backendé¡¹ç›®ï¼Œæ•™æˆå­¦ç”Ÿå¦‚ä½•å®ç°å¾®ä¿¡å…¬ä¼—å·æ‰«ç ç™»å½•åŠŸèƒ½ã€‚è¯¾ç¨‹å†…å®¹å¾ªåºæ¸è¿›ï¼Œæ¯ä¸ªç« èŠ‚10-15åˆ†é’Ÿï¼Œå­¦ç”Ÿåªéœ€å¤åˆ¶ç²˜è´´ä»£ç å³å¯å®ç°æ•ˆæœã€‚

**å‰ç½®è¦æ±‚ï¼š** å…·å¤‡Spring Boot CRUDé¡¹ç›®åŸºç¡€

---

## ç¬¬1ç« ï¼šç¯å¢ƒå‡†å¤‡ä¸é¡¹ç›®é…ç½®ï¼ˆ10åˆ†é’Ÿï¼‰

### ğŸ“‹ æœ¬ç« ç›®æ ‡
- äº†è§£å¾®ä¿¡å…¬ä¼—å·å¼€å‘åŸºç¡€æ¦‚å¿µ
- é…ç½®é¡¹ç›®ä¾èµ–å’ŒåŸºç¡€é…ç½®
- ç†è§£å¾®ä¿¡æ‰«ç ç™»å½•çš„ä¸šåŠ¡æµç¨‹

### ğŸ”§ ä»£ç å®ç°

#### 1.1 æ·»åŠ é¡¹ç›®ä¾èµ–

åœ¨ `pom.xml` ä¸­ç¡®è®¤ä»¥ä¸‹ä¾èµ–å·²å­˜åœ¨ï¼š

```xml:SpringAI-backend%2Fpom.xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>cn.hutool</groupId>
        <artifactId>hutool-all</artifactId>
        <version>5.8.20</version>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupId>org.dom4j</groupId>
        <artifactId>dom4j</artifactId>
        <version>2.1.4</version>
    </dependency>
</dependencies>
```

#### 1.2 é…ç½®å¾®ä¿¡å‚æ•°

åœ¨ `application.properties` ä¸­æ·»åŠ å¾®ä¿¡é…ç½®ï¼š

```properties:SpringAI-backend/src/main/resources/application.properties
# å¾®ä¿¡å…¬ä¼—å·é…ç½®
wechat.appId=ä½ çš„å¾®ä¿¡å…¬ä¼—å·AppID
wechat.appSecret=ä½ çš„å¾®ä¿¡å…¬ä¼—å·AppSecret
wechat.token=ä½ è®¾ç½®çš„Token
wechat.qrcodeExpireSeconds=604800
wechat.qrcode.url-template=https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=%s
wechat.api.token-url=https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=%s&secret=%s
wechat.api.qrcode-url=https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=%s
```

### ğŸ¯ å®ç°æ•ˆæœ
- é¡¹ç›®ä¾èµ–é…ç½®å®Œæˆ
- å¾®ä¿¡å…¬ä¼—å·åŸºç¡€å‚æ•°é…ç½®å®Œæˆ
- ä¸ºåç»­å¼€å‘å¥ å®šåŸºç¡€

---

## ç¬¬2ç« ï¼šå¾®ä¿¡é…ç½®ç±»å¼€å‘ï¼ˆ12åˆ†é’Ÿï¼‰

### ğŸ“‹ æœ¬ç« ç›®æ ‡
- åˆ›å»ºå¾®ä¿¡é…ç½®ç±»ï¼Œç®¡ç†å¾®ä¿¡ç›¸å…³å‚æ•°
- åˆ›å»ºå¾®ä¿¡å¸¸é‡ç±»ï¼Œç»Ÿä¸€ç®¡ç†å¸¸é‡
- ç†è§£Spring Booté…ç½®ç»‘å®šæœºåˆ¶

### ğŸ”§ ä»£ç å®ç°

#### 2.1 åˆ›å»ºå¾®ä¿¡å¸¸é‡ç±»

```java:SpringAI-backend/src/main/java/com/baidu/springai/config/WeChatConstants.java
package com.baidu.springai.config;

/**
 * å¾®ä¿¡ç›¸å…³å¸¸é‡
 * 
 * @author baidu
 * @version 1.0
 */
public final class WeChatConstants {
    
    private WeChatConstants() {}
    
    // äºŒç»´ç ç›¸å…³å¸¸é‡
    public static final int DEFAULT_QRCODE_EXPIRE_SECONDS = 604800;
    public static final String QRCODE_URL_TEMPLATE = "https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=%s";
    
    // APIç›¸å…³å¸¸é‡
    public static final String API_TOKEN_URL = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=%s&secret=%s";
    public static final String API_QRCODE_URL = "https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=%s";
}
```

#### 2.2 åˆ›å»ºå¾®ä¿¡é…ç½®ç±»

```java:SpringAI-backend/src/main/java/com/baidu/springai/config/WeChatConfig.java
package com.baidu.springai.config;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

/**
 * å¾®ä¿¡é…ç½®ç±»
 * ç”¨äºè¯»å–application.propertiesä¸­çš„å¾®ä¿¡ç›¸å…³é…ç½®
 * 
 * @author baidu
 * @version 1.0
 */
@Data
@Component
@ConfigurationProperties(prefix = "wechat")
public class WeChatConfig {
    
    private String appId;
    private String appSecret;
    private String token;
    
    // å¯é…ç½®çš„å€¼ï¼Œå¦‚æœé…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼
    private int qrcodeExpireSeconds = WeChatConstants.DEFAULT_QRCODE_EXPIRE_SECONDS;
    
    // åµŒå¥—é…ç½®
    private Qrcode qrcode = new Qrcode();
    private Api api = new Api();
    
    @Data
    public static class Qrcode {
        private String urlTemplate = WeChatConstants.QRCODE_URL_TEMPLATE;
    }
    
    @Data
    public static class Api {
        private String tokenUrl = WeChatConstants.API_TOKEN_URL;
        private String qrcodeUrl = WeChatConstants.API_QRCODE_URL;
    }
    
    // ä¾¿æ·æ–¹æ³•
    public String getApiTokenUrl() {
        return api.getTokenUrl();
    }
    
    public String getApiQrcodeUrl() {
        return api.getQrcodeUrl();
    }
    
    public String getQrcodeUrlTemplate() {
        return qrcode.getUrlTemplate();
    }
}
```

### ğŸ¯ å®ç°æ•ˆæœ
- å¾®ä¿¡é…ç½®å‚æ•°è‡ªåŠ¨æ³¨å…¥åˆ°é…ç½®ç±»ä¸­
- å¸¸é‡ç»Ÿä¸€ç®¡ç†ï¼Œä¾¿äºç»´æŠ¤
- é…ç½®ç±»æ”¯æŒåµŒå¥—é…ç½®å’Œé»˜è®¤å€¼
- å¯åŠ¨é¡¹ç›®æ—¶å¯ä»¥çœ‹åˆ°é…ç½®ç±»è¢«æ­£ç¡®åŠ è½½

---

## ç¬¬3ç« ï¼šå“åº”å¯¹è±¡è®¾è®¡ï¼ˆ10åˆ†é’Ÿï¼‰

### ğŸ“‹ æœ¬ç« ç›®æ ‡
- è®¾è®¡å¾®ä¿¡APIå“åº”å¯¹è±¡
- åˆ›å»ºç»Ÿä¸€çš„å“åº”æ ¼å¼
- ç†è§£æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰çš„ä½œç”¨

### ğŸ”§ ä»£ç å®ç°

#### 3.1 åˆ›å»ºå¾®ä¿¡è®¿é—®ä»¤ç‰Œå“åº”å¯¹è±¡

```java:SpringAI-backend/src/main/java/com/baidu/springai/domain/WeChatAccessToken.java
package com.baidu.springai.domain;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * å¾®ä¿¡è®¿é—®ä»¤ç‰Œå“åº”å¯¹è±¡
 * ç”¨äºæ¥æ”¶å¾®ä¿¡APIè¿”å›çš„access_tokenä¿¡æ¯
 * 
 * @author baidu
 * @version 1.0
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class WeChatAccessToken {
    
    /**
     * è®¿é—®ä»¤ç‰Œ
     */
    private String accessToken;
    
    /**
     * ä»¤ç‰Œæœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
     */
    private Integer expiresIn;
    
    /**
     * é”™è¯¯ç 
     */
    private Integer errcode;
    
    /**
     * é”™è¯¯ä¿¡æ¯
     */
    private String errmsg;
    
    /**
     * åˆ¤æ–­æ˜¯å¦æˆåŠŸè·å–ä»¤ç‰Œ
     * @return trueè¡¨ç¤ºæˆåŠŸï¼Œfalseè¡¨ç¤ºå¤±è´¥
     */
    public boolean isSuccess() {
        return errcode == null || errcode == 0;
    }
}
```

#### 3.2 åˆ›å»ºäºŒç»´ç è¯·æ±‚å¯¹è±¡

```java:SpringAI-backend/src/main/java/com/baidu/springai/domain/WeChatQrCodeRequest.java
package com.baidu.springai.domain;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * å¾®ä¿¡äºŒç»´ç è¯·æ±‚å¯¹è±¡
 * ç”¨äºæ„å»ºåˆ›å»ºäºŒç»´ç çš„è¯·æ±‚å‚æ•°
 * 
 * @author baidu
 * @version 1.0
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class WeChatQrCodeRequest {
    
    /**
     * äºŒç»´ç ç±»å‹
     * QR_SCENEä¸ºä¸´æ—¶çš„æ•´å‹å‚æ•°å€¼
     * QR_STR_SCENEä¸ºä¸´æ—¶çš„å­—ç¬¦ä¸²å‚æ•°å€¼
     * QR_LIMIT_SCENEä¸ºæ°¸ä¹…çš„æ•´å‹å‚æ•°å€¼
     * QR_LIMIT_STR_SCENEä¸ºæ°¸ä¹…çš„å­—ç¬¦ä¸²å‚æ•°å€¼
     */
    private String actionName;
    
    /**
     * äºŒç»´ç è¯¦ç»†ä¿¡æ¯
     */
    private ActionInfo actionInfo;
    
    /**
     * è¯¥äºŒç»´ç æœ‰æ•ˆæ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚æœ€å¤§ä¸è¶…è¿‡2592000ï¼ˆå³30å¤©ï¼‰
     * æ­¤å­—æ®µå¦‚æœä¸å¡«ï¼Œåˆ™é»˜è®¤æœ‰æ•ˆæœŸä¸º30ç§’
     */
    private Integer expireSeconds;
    
    @Data
    @NoArgsConstructor
    @AllArgsConstructor
    public static class ActionInfo {
        private Scene scene;
        
        @Data
        @NoArgsConstructor
        @AllArgsConstructor
        public static class Scene {
            /**
             * åœºæ™¯å€¼IDï¼Œä¸´æ—¶äºŒç»´ç æ—¶ä¸º32ä½é0æ•´å‹
             */
            private Integer sceneId;
            
            /**
             * åœºæ™¯å€¼IDï¼ˆå­—ç¬¦ä¸²å½¢å¼çš„IDï¼‰ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œé•¿åº¦é™åˆ¶ä¸º1åˆ°64
             */
            private String sceneStr;
        }
    }
    
    /**
     * åˆ›å»ºä¸´æ—¶æ•´å‹åœºæ™¯å€¼äºŒç»´ç è¯·æ±‚
     * @param sceneId åœºæ™¯å€¼ID
     * @param expireSeconds æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
     * @return äºŒç»´ç è¯·æ±‚å¯¹è±¡
     */
    public static WeChatQrCodeRequest createTempQrCode(int sceneId, int expireSeconds) {
        WeChatQrCodeRequest request = new WeChatQrCodeRequest();
        request.setActionName("QR_SCENE");
        request.setExpireSeconds(expireSeconds);
        
        ActionInfo actionInfo = new ActionInfo();
        ActionInfo.Scene scene = new ActionInfo.Scene();
        scene.setSceneId(sceneId);
        actionInfo.setScene(scene);
        request.setActionInfo(actionInfo);
        
        return request;
    }
}
```

#### 3.3 åˆ›å»ºç™»å½•çŠ¶æ€å“åº”å¯¹è±¡

```java:SpringAI-backend/src/main/java/com/baidu/springai/domain/LoginStatusResponse.java
package com.baidu.springai.domain;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * ç™»å½•çŠ¶æ€å“åº”å¯¹è±¡
 * 
 * @author baidu
 * @version 1.0
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class LoginStatusResponse {
    
    /**
     * ç™»å½•çŠ¶æ€
     * 0: æœªæ‰«ç 
     * 1: å·²æ‰«ç ä½†æœªç¡®è®¤
     * 2: å·²ç¡®è®¤ç™»å½•
     */
    private Integer status;
    
    /**
     * ç”¨æˆ·openidï¼ˆç™»å½•æˆåŠŸæ—¶è¿”å›ï¼‰
     */
    private String openid;
    
    /**
     * çŠ¶æ€æè¿°
     */
    private String message;
    
    public static LoginStatusResponse waiting() {
        return new LoginStatusResponse(0, null, "ç­‰å¾…æ‰«ç ");
    }
    
    public static LoginStatusResponse scanned() {
        return new LoginStatusResponse(1, null, "å·²æ‰«ç ï¼Œç­‰å¾…ç¡®è®¤");
    }
    
    public static LoginStatusResponse success(String openid) {
        return new LoginStatusResponse(2, openid, "ç™»å½•æˆåŠŸ");
    }
}
```

#### 3.4 åˆ›å»ºäºŒç»´ç å“åº”å¯¹è±¡

```java:SpringAI-backend/src/main/java/com/baidu/springai/domain/QrCodeResponse.java
package com.baidu.springai.domain;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * äºŒç»´ç å“åº”å¯¹è±¡
 * 
 * @author baidu
 * @version 1.0
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class QrCodeResponse {
    
    /**
     * äºŒç»´ç ç¥¨æ®
     */
    private String ticket;
    
    /**
     * äºŒç»´ç å›¾ç‰‡URL
     */
    private String qrCodeUrl;
    
    /**
     * äºŒç»´ç æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
     */
    private Integer expireSeconds;
}
```

### ğŸ¯ å®ç°æ•ˆæœ
- åˆ›å»ºäº†å®Œæ•´çš„æ•°æ®ä¼ è¾“å¯¹è±¡
- æ”¯æŒå¾®ä¿¡APIçš„è¯·æ±‚å’Œå“åº”æ ¼å¼
- æä¾›äº†ä¾¿æ·çš„é™æ€æ–¹æ³•åˆ›å»ºå¯¹è±¡
- ä»£ç ç»“æ„æ¸…æ™°ï¼Œä¾¿äºç»´æŠ¤

---

## ç¬¬4ç« ï¼šå¾®ä¿¡APIå·¥å…·ç±»å¼€å‘ï¼ˆ15åˆ†é’Ÿï¼‰

### ğŸ“‹ æœ¬ç« ç›®æ ‡
- å¼€å‘å¾®ä¿¡APIè°ƒç”¨å·¥å…·ç±»
- å®ç°è·å–access_tokenåŠŸèƒ½
- å®ç°åˆ›å»ºäºŒç»´ç åŠŸèƒ½
- ç†è§£HTTPå®¢æˆ·ç«¯è°ƒç”¨

### ğŸ”§ ä»£ç å®ç°

#### 4.1 åˆ›å»ºå¾®ä¿¡APIå·¥å…·ç±»

```java:SpringAI-backend/src/main/java/com/baidu/springai/utils/WeChatApiUtil.java
package com.baidu.springai.utils;

import cn.hutool.http.HttpUtil;
import cn.hutool.json.JSONObject;
import cn.hutool.json.JSONUtil;
import com.baidu.springai.domain.WeChatAccessToken;
import com.baidu.springai.exception.BusinessException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import com.baidu.springai.config.WeChatConfig;

/**
 * å¾®ä¿¡APIå·¥å…·ç±»
 * æä¾›å¾®ä¿¡å…¬ä¼—å·APIè°ƒç”¨çš„å°è£…æ–¹æ³•
 * 
 * @author baidu
 * @version 1.0
 */
@Slf4j
@Component
public class WeChatApiUtil {
    
    private static WeChatConfig weChatConfig;
    
    @Autowired
    public void setWeChatConfig(WeChatConfig weChatConfig) {
        WeChatApiUtil.weChatConfig = weChatConfig;
    }

    /**
     * è·å–å¾®ä¿¡è®¿é—®ä»¤ç‰Œ
     */
    public static WeChatAccessToken getAccessToken(String appId, String appSecret) {
        validateTokenParams(appId, appSecret);
        
        String url = String.format(weChatConfig.getApiTokenUrl(), appId.trim(), appSecret.trim());
        log.info("æ­£åœ¨è·å–å¾®ä¿¡access_tokenï¼Œè¯·æ±‚URL: {}", url);
        
        try {
            String responseBody = HttpUtil.get(url);
            log.info("å¾®ä¿¡access_tokenå“åº”: {}", responseBody);
            
            return parseTokenResponse(responseBody);
        } catch (Exception e) {
            log.error("è·å–å¾®ä¿¡access_tokenå¤±è´¥", e);
            throw new BusinessException("è·å–å¾®ä¿¡access_tokenå¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * åˆ›å»ºäºŒç»´ç 
     */
    public static String createQrCode(String accessToken, int sceneId) {
        validateQrCodeParams(accessToken, sceneId);
        
        String url = String.format(weChatConfig.getApiQrcodeUrl(), accessToken.trim());
        JSONObject requestJson = buildQrCodeRequest(sceneId);
        
        String responseBody = HttpUtil.post(url, requestJson.toString());
        return parseQrCodeResponse(responseBody);
    }

    /**
     * éªŒè¯è·å–tokençš„å‚æ•°
     */
    private static void validateTokenParams(String appId, String appSecret) {
        if (appId == null || appId.trim().isEmpty()) {
            throw new BusinessException("AppIDä¸èƒ½ä¸ºç©º");
        }
        if (appSecret == null || appSecret.trim().isEmpty()) {
            throw new BusinessException("AppSecretä¸èƒ½ä¸ºç©º");
        }
    }

    /**
     * éªŒè¯åˆ›å»ºäºŒç»´ç çš„å‚æ•°
     */
    private static void validateQrCodeParams(String accessToken, int sceneId) {
        if (accessToken == null || accessToken.trim().isEmpty()) {
            throw new BusinessException("AccessTokenä¸èƒ½ä¸ºç©º");
        }
        if (sceneId <= 0) {
            throw new BusinessException("åœºæ™¯å€¼IDå¿…é¡»å¤§äº0");
        }
    }

    /**
     * è§£ætokenå“åº”
     */
    private static WeChatAccessToken parseTokenResponse(String responseBody) {
        try {
            JSONObject jsonResponse = JSONUtil.parseObj(responseBody);
            
            WeChatAccessToken token = new WeChatAccessToken();
            token.setAccessToken(jsonResponse.getStr("access_token"));
            token.setExpiresIn(jsonResponse.getInt("expires_in"));
            token.setErrcode(jsonResponse.getInt("errcode"));
            token.setErrmsg(jsonResponse.getStr("errmsg"));
            
            return token;
        } catch (Exception e) {
            log.error("è§£æå¾®ä¿¡tokenå“åº”å¤±è´¥: {}", responseBody, e);
            throw new BusinessException("è§£æå¾®ä¿¡tokenå“åº”å¤±è´¥");
        }
    }

    /**
     * æ„å»ºäºŒç»´ç è¯·æ±‚JSON
     */
    private static JSONObject buildQrCodeRequest(int sceneId) {
        JSONObject requestJson = new JSONObject();
        requestJson.set("expire_seconds", weChatConfig.getQrcodeExpireSeconds());
        requestJson.set("action_name", "QR_SCENE");
        
        JSONObject actionInfo = new JSONObject();
        JSONObject scene = new JSONObject();
        scene.set("scene_id", sceneId);
        actionInfo.set("scene", scene);
        requestJson.set("action_info", actionInfo);
        
        log.info("åˆ›å»ºäºŒç»´ç è¯·æ±‚å‚æ•°: {}", requestJson.toString());
        return requestJson;
    }

    /**
     * è§£æäºŒç»´ç å“åº”
     */
    private static String parseQrCodeResponse(String responseBody) {
        try {
            log.info("å¾®ä¿¡äºŒç»´ç åˆ›å»ºå“åº”: {}", responseBody);
            JSONObject jsonResponse = JSONUtil.parseObj(responseBody);
            
            if (jsonResponse.containsKey("errcode") && jsonResponse.getInt("errcode") != 0) {
                String errmsg = jsonResponse.getStr("errmsg");
                log.error("åˆ›å»ºäºŒç»´ç å¤±è´¥: {}", errmsg);
                throw new BusinessException("åˆ›å»ºäºŒç»´ç å¤±è´¥: " + errmsg);
            }
            
            String ticket = jsonResponse.getStr("ticket");
            if (ticket == null || ticket.trim().isEmpty()) {
                throw new BusinessException("äºŒç»´ç ticketä¸ºç©º");
            }
            
            return ticket;
        } catch (BusinessException e) {
            throw e;
        } catch (Exception e) {
            log.error("è§£æäºŒç»´ç å“åº”å¤±è´¥: {}", responseBody, e);
            throw new BusinessException("è§£æäºŒç»´ç å“åº”å¤±è´¥");
        }
    }

    /**
     * æ ¹æ®ticketç”ŸæˆäºŒç»´ç URL
     */
    public static String generateQrCodeUrl(String ticket) {
        if (ticket == null || ticket.trim().isEmpty()) {
            throw new BusinessException("äºŒç»´ç ticketä¸èƒ½ä¸ºç©º");
        }
        return String.format(weChatConfig.getQrcodeUrlTemplate(), ticket);
    }
}
```

### ğŸ¯ å®ç°æ•ˆæœ
- æˆåŠŸè°ƒç”¨å¾®ä¿¡APIè·å–access_token
- æˆåŠŸåˆ›å»ºä¸´æ—¶äºŒç»´ç å¹¶è·å–ticket
- å®Œå–„çš„å‚æ•°éªŒè¯å’Œå¼‚å¸¸å¤„ç†
- è¯¦ç»†çš„æ—¥å¿—è®°å½•ä¾¿äºè°ƒè¯•
- å¯ä»¥é€šè¿‡æ—¥å¿—æŸ¥çœ‹APIè°ƒç”¨è¿‡ç¨‹

---

## ç¬¬5ç« ï¼šå¾®ä¿¡ç™»å½•æœåŠ¡æ ¸å¿ƒé€»è¾‘å¼€å‘ï¼ˆ15åˆ†é’Ÿï¼‰

### ğŸ“‹ æœ¬ç« ç›®æ ‡
- å¼€å‘å¾®ä¿¡ç™»å½•æœåŠ¡æ¥å£å’Œå®ç°ç±»
- å®ç°äºŒç»´ç ç”Ÿæˆå’Œç™»å½•çŠ¶æ€ç®¡ç†
- ç†è§£ä¸šåŠ¡é€»è¾‘å±‚çš„è®¾è®¡æ¨¡å¼

### ğŸ”§ ä»£ç å®ç°

#### 5.1 åˆ›å»ºç™»å½•æœåŠ¡æ¥å£

```java:SpringAI-backend/src/main/java/com/baidu/springai/service/WeiXinLoginService.java
package com.baidu.springai.service;

import jakarta.servlet.http.HttpServletRequest;

/**
 * ç™»å½•æœåŠ¡æ¥å£
 * å®šä¹‰å¾®ä¿¡æ‰«ç ç™»å½•ç›¸å…³çš„ä¸šåŠ¡æ“ä½œ
 * 
 * @author baidu
 * @version 1.0
 */
public interface WeiXinLoginService {
    
    /**
     * åˆ›å»ºäºŒç»´ç ç™»å½•ç¥¨æ®
     * 
     * @return ç™»å½•ç¥¨æ®
     */
    String createQrCodeTicket();
    
    /**
     * æ£€æŸ¥ç™»å½•çŠ¶æ€
     * 
     * @param ticket ç™»å½•ç¥¨æ®
     * @return ç”¨æˆ·openidæˆ–null
     */
    String checkLoginStatus(String ticket);
    
    /**
     * ä¿å­˜ç™»å½•çŠ¶æ€
     * 
     * @param ticket ç™»å½•ç¥¨æ®
     * @param openid ç”¨æˆ·openid
     */
    void saveLoginStatus(String ticket, String openid);
    
    /**
     * å¤„ç†å¾®ä¿¡æ¶ˆæ¯
     * 
     * @param request HTTPè¯·æ±‚
     * @return å“åº”æ¶ˆæ¯
     */
    String handleWeChatMessage(HttpServletRequest request);
    
    /**
     * æ ¹æ®åœºæ™¯IDè·å–ç¥¨æ®
     * 
     * @param sceneId åœºæ™¯ID
     * @return ç¥¨æ®
     */
    String getTicketBySceneId(String sceneId);
}
```

#### 5.2 åˆ›å»ºç™»å½•æœåŠ¡å®ç°ç±»

```java:SpringAI-backend/src/main/java/com/baidu/springai/service/impl/WeiXinLoginServiceImpl.java
package com.baidu.springai.service.impl;

import com.baidu.springai.config.WeChatConfig;
import com.baidu.springai.domain.WeChatAccessToken;
import com.baidu.springai.domain.WeChatMessage;
import com.baidu.springai.exception.BusinessException;
import com.baidu.springai.service.WeiXinLoginService;
import com.baidu.springai.utils.WeChatApiUtil;
import com.baidu.springai.utils.XmlUtil;
import jakarta.servlet.http.HttpServletRequest;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.ByteArrayInputStream;
import java.nio.charset.StandardCharsets;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.ThreadLocalRandom;

/**
 * å¾®ä¿¡ç™»å½•æœåŠ¡å®ç°ç±»
 * 
 * @author baidu
 * @version 1.0
 */
@Service
@Slf4j
public class WeiXinLoginServiceImpl implements WeiXinLoginService {

    @Autowired
    private WeChatConfig weChatConfig;
    
    private final Map<String, String> loginStateMap = new HashMap<>();
    // æ·»åŠ åœºæ™¯IDåˆ°ç¥¨æ®çš„æ˜ å°„
    private final Map<String, String> sceneToTicketMap = new HashMap<>();

    @Override
    public String createQrCodeTicket() {
        WeChatAccessToken accessToken = WeChatApiUtil.getAccessToken(weChatConfig.getAppId(), weChatConfig.getAppSecret());
        if (!accessToken.isSuccess()) {
            throw new BusinessException("è·å–å¾®ä¿¡access_tokenå¤±è´¥: " + accessToken.getErrmsg());
        }

        int sceneId = generateUniqueSceneId();
        String ticket = WeChatApiUtil.createQrCode(accessToken.getAccessToken(), sceneId);
        
        // ä¿å­˜åœºæ™¯IDå’Œç¥¨æ®çš„æ˜ å°„å…³ç³»
        sceneToTicketMap.put(String.valueOf(sceneId), ticket);
        
        log.info("åˆ›å»ºäºŒç»´ç æˆåŠŸï¼Œåœºæ™¯ID: {}, ç¥¨æ®: {}", sceneId, ticket);
        return ticket;
    }

    @Override
    public String checkLoginStatus(String ticket) {
        String openid = loginStateMap.get(ticket);
        log.info("æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œç¥¨æ®: {}, openid: {}", ticket, openid);
        return openid;
    }

    @Override
    public void saveLoginStatus(String ticket, String openid) {
        loginStateMap.put(ticket, openid);
        log.info("ä¿å­˜ç™»å½•çŠ¶æ€ï¼Œç¥¨æ®: {}, openid: {}", ticket, openid);
    }

    @Override
    public String handleWeChatMessage(HttpServletRequest request) {
        try {
            // è¯»å–è¯·æ±‚ä½“
            String requestBody = readRequestBody(request);
            log.info("æ”¶åˆ°å¾®ä¿¡æ¶ˆæ¯: {}", requestBody);
            
            // è§£æXMLæ¶ˆæ¯
            WeChatMessage message = parseWeChatMessage(requestBody);
            
            // å¤„ç†æ‰«ç äº‹ä»¶
            if ("event".equals(message.getMsgType()) && "SCAN".equals(message.getEvent())) {
                handleScanEvent(message);
            }
            
            return "success";
        } catch (Exception e) {
            log.error("å¤„ç†å¾®ä¿¡æ¶ˆæ¯å¤±è´¥", e);
            return "error";
        }
    }

    @Override
    public String getTicketBySceneId(String sceneId) {
        return sceneToTicketMap.get(sceneId);
    }

    /**
     * ç”Ÿæˆå”¯ä¸€çš„åœºæ™¯ID
     */
    private int generateUniqueSceneId() {
        return ThreadLocalRandom.current().nextInt(100000, 999999);
    }

    /**
     * è¯»å–è¯·æ±‚ä½“
     */
    private String readRequestBody(HttpServletRequest request) {
        try {
            StringBuilder sb = new StringBuilder();
            String line;
            while ((line = request.getReader().readLine()) != null) {
                sb.append(line);
            }
            return sb.toString();
        } catch (Exception e) {
            log.error("è¯»å–è¯·æ±‚ä½“å¤±è´¥", e);
            throw new BusinessException("è¯»å–è¯·æ±‚ä½“å¤±è´¥");
        }
    }

    /**
     * è§£æå¾®ä¿¡XMLæ¶ˆæ¯
     */
    private WeChatMessage parseWeChatMessage(String xmlContent) {
        try {
            ByteArrayInputStream inputStream = new ByteArrayInputStream(xmlContent.getBytes(StandardCharsets.UTF_8));
            Map<String, String> messageMap = XmlUtil.parseXmlToMap(inputStream);
            
            WeChatMessage message = new WeChatMessage();
            message.setToUserName(messageMap.get("ToUserName"));
            message.setFromUserName(messageMap.get("FromUserName"));
            message.setCreateTime(messageMap.get("CreateTime"));
            message.setMsgType(messageMap.get("MsgType"));
            message.setEvent(messageMap.get("Event"));
            message.setEventKey(messageMap.get("EventKey"));
            message.setTicket(messageMap.get("Ticket"));
            
            return message;
        } catch (Exception e) {
            log.error("è§£æå¾®ä¿¡XMLæ¶ˆæ¯å¤±è´¥: {}", xmlContent, e);
            throw new BusinessException("è§£æå¾®ä¿¡æ¶ˆæ¯å¤±è´¥");
        }
    }

    /**
     * å¤„ç†æ‰«ç äº‹ä»¶
     */
    private void handleScanEvent(WeChatMessage message) {
        String eventKey = message.getEventKey();
        String openid = message.getFromUserName();
        
        log.info("å¤„ç†æ‰«ç äº‹ä»¶ï¼Œåœºæ™¯å€¼: {}, ç”¨æˆ·openid: {}", eventKey, openid);
        
        // æ ¹æ®åœºæ™¯IDè·å–å¯¹åº”çš„ç¥¨æ®
        String ticket = getTicketBySceneId(eventKey);
        if (ticket != null) {
            // ä¿å­˜ç™»å½•çŠ¶æ€
            saveLoginStatus(ticket, openid);
            log.info("ç”¨æˆ·æ‰«ç ç™»å½•æˆåŠŸï¼Œç¥¨æ®: {}, openid: {}", ticket, openid);
        } else {
            log.warn("æœªæ‰¾åˆ°åœºæ™¯IDå¯¹åº”çš„ç¥¨æ®: {}", eventKey);
        }
    }
}
```

#### 5.3 åˆ›å»ºå¾®ä¿¡æ¶ˆæ¯å¯¹è±¡

```java:SpringAI-backend/src/main/java/com/baidu/springai/domain/WeChatMessage.java
package com.baidu.springai.domain;

import lombok.Data;

/**
 * å¾®ä¿¡æ¶ˆæ¯å¯¹è±¡
 * ç”¨äºæ¥æ”¶å’Œè§£æå¾®ä¿¡æ¨é€çš„æ¶ˆæ¯
 * 
 * @author baidu
 * @version 1.0
 */
@Data
public class WeChatMessage {
    
    /**
     * æ¥æ”¶æ–¹å¾®ä¿¡å·
     */
    private String toUserName;
    
    /**
     * å‘é€æ–¹openid
     */
    private String fromUserName;
    
    /**
     * æ¶ˆæ¯åˆ›å»ºæ—¶é—´
     */
    private String createTime;
    
    /**
     * æ¶ˆæ¯ç±»å‹
     */
    private String msgType;
    
    /**
     * äº‹ä»¶ç±»å‹
     */
    private String event;
    
    /**
     * äº‹ä»¶KEYå€¼
     */
    private String eventKey;
    
    /**
     * äºŒç»´ç çš„ticket
     */
    private String ticket;
    
    /**
     * æ¶ˆæ¯å†…å®¹
     */
    private String content;
}
```

### ğŸ¯ å®ç°æ•ˆæœ
- æˆåŠŸåˆ›å»ºäºŒç»´ç ç¥¨æ®å¹¶ç”Ÿæˆå”¯ä¸€åœºæ™¯ID
- å®ç°ç™»å½•çŠ¶æ€çš„å†…å­˜å­˜å‚¨å’ŒæŸ¥è¯¢
- èƒ½å¤Ÿå¤„ç†å¾®ä¿¡æ¨é€çš„æ‰«ç äº‹ä»¶
- å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘å°è£…ï¼Œä¾¿äºæµ‹è¯•å’Œç»´æŠ¤

---

## ç¬¬6ç« ï¼šè®¤è¯æ§åˆ¶å™¨å¼€å‘ï¼ˆ12åˆ†é’Ÿï¼‰

### ğŸ“‹ æœ¬ç« ç›®æ ‡
- å¼€å‘è®¤è¯ç›¸å…³çš„REST APIæ¥å£
- å®ç°äºŒç»´ç ç”Ÿæˆå’Œç™»å½•çŠ¶æ€æŸ¥è¯¢æ¥å£
- ç†è§£RESTful APIè®¾è®¡åŸåˆ™

### ğŸ”§ ä»£ç å®ç°

#### 6.1 åˆ›å»ºè®¤è¯æ§åˆ¶å™¨

```java:SpringAI-backend/src/main/java/com/baidu/springai/controller/AuthController.java
package com.baidu.springai.controller;

import cn.hutool.core.codec.Base64;
import cn.hutool.http.HttpUtil;
import com.baidu.springai.config.WeChatConfig;
import com.baidu.springai.domain.LoginStatusResponse;
import com.baidu.springai.domain.QrCodeResponse;
import com.baidu.springai.resp.Response;
import com.baidu.springai.service.WeiXinLoginService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * è®¤è¯æ§åˆ¶å™¨
 * æä¾›æ‰«ç ç™»å½•ç›¸å…³çš„APIæ¥å£
 *
 * @author baidu
 * @version 1.0
 */
@Slf4j
@RestController
@RequestMapping("/api/auth")
@CrossOrigin
public class AuthController {

    @Autowired
    private WeiXinLoginService weiXinLoginService;
    
    @Autowired
    private WeChatConfig weChatConfig;

    /**
     * ç”Ÿæˆç™»å½•äºŒç»´ç 
     * 
     * @return äºŒç»´ç ä¿¡æ¯
     */
    @GetMapping("/qrcode")
    public Response<QrCodeResponse> generateQrCode() {
        try {
            log.info("å¼€å§‹ç”Ÿæˆç™»å½•äºŒç»´ç ");
            
            // åˆ›å»ºäºŒç»´ç ç¥¨æ®
            String ticket = weiXinLoginService.createQrCodeTicket();
            
            // ç”ŸæˆäºŒç»´ç URL
            String qrCodeUrl = String.format(weChatConfig.getQrcodeUrlTemplate(), ticket);
            
            // ä¸‹è½½äºŒç»´ç å›¾ç‰‡å¹¶è½¬æ¢ä¸ºBase64
            String qrCodeBase64 = downloadAndEncodeQrCode(qrCodeUrl);
            
            // æ„å»ºå“åº”å¯¹è±¡
            QrCodeResponse qrCodeResponse = new QrCodeResponse();
            qrCodeResponse.setTicket(ticket);
            qrCodeResponse.setQrCodeUrl("data:image/png;base64," + qrCodeBase64);
            qrCodeResponse.setExpireSeconds(weChatConfig.getQrcodeExpireSeconds());
            
            log.info("ç”Ÿæˆç™»å½•äºŒç»´ç æˆåŠŸï¼Œç¥¨æ®: {}", ticket);
            return Response.success(qrCodeResponse);
            
        } catch (Exception e) {
            log.error("ç”Ÿæˆç™»å½•äºŒç»´ç å¤±è´¥", e);
            return Response.error("ç”ŸæˆäºŒç»´ç å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * æ£€æŸ¥ç™»å½•çŠ¶æ€
     * 
     * @param ticket äºŒç»´ç ç¥¨æ®
     * @return ç™»å½•çŠ¶æ€
     */
    @GetMapping("/status")
    public Response<LoginStatusResponse> checkLoginStatus(@RequestParam String ticket) {
        try {
            log.info("æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œç¥¨æ®: {}", ticket);
            
            String openid = weiXinLoginService.checkLoginStatus(ticket);
            
            LoginStatusResponse statusResponse;
            if (openid != null) {
                statusResponse = LoginStatusResponse.success(openid);
                log.info("ç”¨æˆ·å·²ç™»å½•ï¼Œopenid: {}", openid);
            } else {
                statusResponse = LoginStatusResponse.waiting();
                log.info("ç”¨æˆ·æœªç™»å½•ï¼Œç»§ç»­ç­‰å¾…æ‰«ç ");
            }
            
            return Response.success(statusResponse);
            
        } catch (Exception e) {
            log.error("æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥", e);
            return Response.error("æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * ä¸‹è½½äºŒç»´ç å›¾ç‰‡å¹¶ç¼–ç ä¸ºBase64
     */
    private String downloadAndEncodeQrCode(String qrCodeUrl) {
        try {
            log.info("ä¸‹è½½äºŒç»´ç å›¾ç‰‡: {}", qrCodeUrl);
            
            // ä¸‹è½½äºŒç»´ç å›¾ç‰‡
            byte[] imageBytes = HttpUtil.downloadBytes(qrCodeUrl);
            
            // è½¬æ¢ä¸ºBase64ç¼–ç 
            String base64Image = Base64.encode(imageBytes);
            
            log.info("äºŒç»´ç å›¾ç‰‡ä¸‹è½½å¹¶ç¼–ç æˆåŠŸï¼Œå¤§å°: {} bytes", imageBytes.length);
            return base64Image;
            
        } catch (Exception e) {
            log.error("ä¸‹è½½äºŒç»´ç å›¾ç‰‡å¤±è´¥: {}", qrCodeUrl, e);
            throw new RuntimeException("ä¸‹è½½äºŒç»´ç å›¾ç‰‡å¤±è´¥", e);
        }
    }
}
```

#### 6.2 åˆ›å»ºå¾®ä¿¡æ§åˆ¶å™¨ï¼ˆå¤„ç†å¾®ä¿¡å›è°ƒï¼‰

```java:SpringAI-backend/src/main/java/com/baidu/springai/controller/WeChatController.java
package com.baidu.springai.controller;

import cn.hutool.core.codec.Base64;
import cn.hutool.http.HttpUtil;
import com.baidu.springai.config.WeChatConfig;
import com.baidu.springai.resp.Response;
import com.baidu.springai.service.WeiXinLoginService;
import com.baidu.springai.utils.SignatureUtil;
import jakarta.servlet.http.HttpServletRequest;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

/**
 * å¾®ä¿¡æ§åˆ¶å™¨
 * å¤„ç†å¾®ä¿¡å…¬ä¼—å·çš„å›è°ƒè¯·æ±‚
 *
 * @author baidu
 * @version 1.0
 */
@Slf4j
@RestController
@RequestMapping("/api/v1/wechat")
@CrossOrigin
public class WeChatController {

    @Autowired
    private WeChatConfig weChatConfig;
    
    @Autowired
    private WeiXinLoginService weiXinLoginService;

    /**
     * å¾®ä¿¡æœåŠ¡å™¨éªŒè¯æ¥å£
     */
    @GetMapping("/webhook")
    public String verifyWeChatSignature(String signature, String timestamp, String nonce, String echostr) {
        return SignatureUtil.verifyWeChatSignature(signature, timestamp, nonce, weChatConfig.getToken()) 
            ? echostr : "error";
    }

    /**
     * æ¥æ”¶å¾®ä¿¡æ¶ˆæ¯
     */
    @PostMapping("/webhook")
    public String receiveWeChatMessage(HttpServletRequest request) {
        return weiXinLoginService.handleWeChatMessage(request);
    }

    /**
     * ç”ŸæˆäºŒç»´ç ç¥¨æ®ï¼ˆä¾›æµ‹è¯•ä½¿ç”¨ï¼‰
     */
    @GetMapping("/qrcode/ticket")
    public Response<String> generateQrCodeTicket() {
        String ticket = weiXinLoginService.createQrCodeTicket();
        return Response.success(ticket);
    }

    /**
     * è·å–äºŒç»´ç å›¾ç‰‡
     */
    @GetMapping("/qrcode/image")
    public ResponseEntity<byte[]> getQrCodeImage(@RequestParam String ticket) {
        try {
            String qrCodeUrl = String.format(weChatConfig.getQrcodeUrlTemplate(), ticket);
            byte[] imageBytes = HttpUtil.downloadBytes(qrCodeUrl);
            
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.IMAGE_PNG);
            headers.setContentLength(imageBytes.length);
            
            return ResponseEntity.ok().headers(headers).body(imageBytes);
        } catch (Exception e) {
            log.error("è·å–äºŒç»´ç å›¾ç‰‡å¤±è´¥", e);
            return ResponseEntity.notFound().build();
        }
    }

    /**
     * è·å–äºŒç»´ç Base64ç¼–ç 
     */
    @GetMapping("/qrcode/base64")
    public Response<String> getQrCodeBase64(@RequestParam String ticket) {
        try {
            String qrCodeUrl = String.format(weChatConfig.getQrcodeUrlTemplate(), ticket);
            byte[] imageBytes = HttpUtil.downloadBytes(qrCodeUrl);
            String base64Image = Base64.encode(imageBytes);
            
            return Response.success("data:image/png;base64," + base64Image);
        } catch (Exception e) {
            log.error("è·å–äºŒç»´ç Base64å¤±è´¥", e);
            return Response.error("è·å–äºŒç»´ç å¤±è´¥: " + e.getMessage());
        }
    }
}
```

### ğŸ¯ å®ç°æ•ˆæœ
- æä¾› `/api/auth/qrcode` æ¥å£ç”Ÿæˆç™»å½•äºŒç»´ç 
- æä¾› `/api/auth/status` æ¥å£æŸ¥è¯¢ç™»å½•çŠ¶æ€
- æä¾›å¾®ä¿¡å›è°ƒæ¥å£å¤„ç†æ‰«ç äº‹ä»¶
- æ”¯æŒäºŒç»´ç å›¾ç‰‡çš„å¤šç§æ ¼å¼è¿”å›ï¼ˆBase64ã€äºŒè¿›åˆ¶ï¼‰
- å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•

---

## ç¬¬7ç« ï¼šXMLè§£æå·¥å…·å’Œå¼‚å¸¸å¤„ç†ï¼ˆ10åˆ†é’Ÿï¼‰

### ğŸ“‹ æœ¬ç« ç›®æ ‡
- å¼€å‘XMLè§£æå·¥å…·ç±»
- åˆ›å»ºä¸šåŠ¡å¼‚å¸¸ç±»
- å¼€å‘ç­¾åéªŒè¯å·¥å…·
- å®Œå–„é¡¹ç›®çš„å·¥å…·ç±»ä½“ç³»

### ğŸ”§ ä»£ç å®ç°

#### 7.1 åˆ›å»ºXMLè§£æå·¥å…·ç±»

```java:SpringAI-backend/src/main/java/com/baidu/springai/utils/XmlUtil.java
package com.baidu.springai.utils;

import lombok.extern.slf4j.Slf4j;
import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.dom4j.Element;
import org.dom4j.io.SAXReader;

import java.io.InputStream;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * XMLè§£æå·¥å…·ç±»
 * ç”¨äºè§£æå¾®ä¿¡æ¨é€çš„XMLæ¶ˆæ¯
 * 
 * @author baidu
 * @version 1.0
 */
@Slf4j
public class XmlUtil {
    
    /**
     * å°†XMLè¾“å…¥æµè§£æä¸ºMap
     * 
     * @param inputStream XMLè¾“å…¥æµ
     * @return è§£æåçš„Map
     * @throws DocumentException è§£æå¼‚å¸¸
     */
    public static Map<String, String> parseXmlToMap(InputStream inputStream) throws DocumentException {
        Map<String, String> map = new HashMap<>();
        
        SAXReader reader = new SAXReader();
        Document document = reader.read(inputStream);
        Element root = document.getRootElement();
        
        parseElement(root, map);
        
        log.info("XMLè§£æå®Œæˆï¼Œè§£æç»“æœ: {}", map);
        return map;
    }
    
    /**
     * é€’å½’è§£æXMLå…ƒç´ 
     * 
     * @param element XMLå…ƒç´ 
     * @param map å­˜å‚¨è§£æç»“æœçš„Map
     */
    private static void parseElement(Element element, Map<String, String> map) {
        @SuppressWarnings("unchecked")
        List<Element> elements = element.elements();
        
        if (elements.isEmpty()) {
            // å¶å­èŠ‚ç‚¹ï¼Œç›´æ¥å­˜å‚¨å€¼
            String value = element.getTextTrim();
            if (!value.isEmpty()) {
                map.put(element.getName(), value);
            }
        } else {
            // éå¶å­èŠ‚ç‚¹ï¼Œé€’å½’è§£æå­å…ƒç´ 
            for (Element childElement : elements) {
                parseElement(childElement, map);
            }
        }
    }
    
    /**
     * å°†XMLå­—ç¬¦ä¸²è§£æä¸ºMap
     * 
     * @param xmlString XMLå­—ç¬¦ä¸²
     * @return è§£æåçš„Map
     */
    public static Map<String, String> parseXmlStringToMap(String xmlString) {
        try {
            SAXReader reader = new SAXReader();
            Document document = reader.read(new java.io.StringReader(xmlString));
            Element root = document.getRootElement();
            
            Map<String, String> map = new HashMap<>();
            parseElement(root, map);
            
            return map;
        } catch (Exception e) {
            log.error("è§£æXMLå­—ç¬¦ä¸²å¤±è´¥: {}", xmlString, e);
            throw new RuntimeException("è§£æXMLå¤±è´¥", e);
        }
    }
}
```

#### 7.2 åˆ›å»ºä¸šåŠ¡å¼‚å¸¸ç±»

```java:SpringAI-backend/src/main/java/com/baidu/springai/exception/BusinessException.java
package com.baidu.springai.exception;

/**
 * ä¸šåŠ¡å¼‚å¸¸ç±»
 * ç”¨äºå¤„ç†ä¸šåŠ¡é€»è¾‘ä¸­çš„å¼‚å¸¸æƒ…å†µ
 * 
 * @author baidu
 * @version 1.0
 */
public class BusinessException extends RuntimeException {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * é”™è¯¯ç 
     */
    private String errorCode;
    
    /**
     * é”™è¯¯æ¶ˆæ¯
     */
    private String errorMessage;
    
    public BusinessException(String message) {
        super(message);
        this.errorMessage = message;
    }
    
    public BusinessException(String errorCode, String message) {
        super(message);
        this.errorCode = errorCode;
        this.errorMessage = message;
    }
    
    public BusinessException(String message, Throwable cause) {
        super(message, cause);
        this.errorMessage = message;
    }
    
    public BusinessException(String errorCode, String message, Throwable cause) {
        super(message, cause);
        this.errorCode = errorCode;
        this.errorMessage = message;
    }
    
    public String getErrorCode() {
        return errorCode;
    }
    
    public String getErrorMessage() {
        return errorMessage;
    }
}
```

#### 7.3 åˆ›å»ºç­¾åéªŒè¯å·¥å…·ç±»

```java:SpringAI-backend/src/main/java/com/baidu/springai/utils/SignatureUtil.java
package com.baidu.springai.utils;

import lombok.extern.slf4j.Slf4j;

import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.Arrays;

/**
 * ç­¾åéªŒè¯å·¥å…·ç±»
 * ç”¨äºéªŒè¯å¾®ä¿¡æœåŠ¡å™¨çš„ç­¾å
 * 
 * @author baidu
 * @version 1.0
 */
@Slf4j
public class SignatureUtil {

    /**
     * éªŒè¯å¾®ä¿¡ç­¾å
     * 
     * @param signature å¾®ä¿¡ç­¾å
     * @param timestamp æ—¶é—´æˆ³
     * @param nonce éšæœºæ•°
     * @param token é…ç½®çš„token
     * @return éªŒè¯ç»“æœ
     */
    public static boolean verifyWeChatSignature(String signature, String timestamp, String nonce, String token) {
        try {
            log.info("å¼€å§‹éªŒè¯å¾®ä¿¡ç­¾åï¼Œsignature: {}, timestamp: {}, nonce: {}", signature, timestamp, nonce);
            
            // å‚æ•°éªŒè¯
            if (signature == null || timestamp == null || nonce == null || token == null) {
                log.warn("ç­¾åéªŒè¯å‚æ•°ä¸å®Œæ•´");
                return false;
            }
            
            // 1. å°†tokenã€timestampã€nonceä¸‰ä¸ªå‚æ•°è¿›è¡Œå­—å…¸åºæ’åº
            String[] array = {token, timestamp, nonce};
            Arrays.sort(array);
            
            // 2. å°†ä¸‰ä¸ªå‚æ•°å­—ç¬¦ä¸²æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œsha1åŠ å¯†
            StringBuilder sb = new StringBuilder();
            for (String str : array) {
                sb.append(str);
            }
            
            String encryptedString = sha1Encrypt(sb.toString());
            log.info("è®¡ç®—å¾—åˆ°çš„ç­¾å: {}", encryptedString);
            
            // 3. å¼€å‘è€…è·å¾—åŠ å¯†åçš„å­—ç¬¦ä¸²å¯ä¸signatureå¯¹æ¯”ï¼Œæ ‡è¯†è¯¥è¯·æ±‚æ¥æºäºå¾®ä¿¡
            boolean result = encryptedString.equals(signature);
            log.info("ç­¾åéªŒè¯ç»“æœ: {}", result);
            
            return result;
            
        } catch (Exception e) {
            log.error("éªŒè¯å¾®ä¿¡ç­¾åå¤±è´¥", e);
            return false;
        }
    }

    /**
     * SHA1åŠ å¯†
     * 
     * @param data å¾…åŠ å¯†æ•°æ®
     * @return åŠ å¯†åçš„å­—ç¬¦ä¸²
     */
    private static String sha1Encrypt(String data) {
        try {
            MessageDigest md = MessageDigest.getInstance("SHA-1");
            byte[] digest = md.digest(data.getBytes());
            
            StringBuilder sb = new StringBuilder();
            for (byte b : digest) {
                sb.append(String.format("%02x", b));
            }
            
            return sb.toString();
        } catch (NoSuchAlgorithmException e) {
            log.error("SHA1åŠ å¯†å¤±è´¥", e);
            throw new RuntimeException("SHA1åŠ å¯†å¤±è´¥", e);
        }
    }
    
    /**
     * éªŒè¯å­—ç¬¦ä¸²æ˜¯å¦ä¸ºæœ‰æ•ˆçš„SHA1ç­¾åæ ¼å¼
     * 
     * @param signature ç­¾åå­—ç¬¦ä¸²
     * @return æ˜¯å¦æœ‰æ•ˆ
     */
    public static boolean isValidSignatureFormat(String signature) {
        if (signature == null || signature.length() != 40) {
            return false;
        }
        
        return signature.matches("[a-f0-9]{40}");
    }
}
```

### ğŸ¯ å®ç°æ•ˆæœ
- æˆåŠŸè§£æå¾®ä¿¡æ¨é€çš„XMLæ¶ˆæ¯
- å®Œå–„çš„ä¸šåŠ¡å¼‚å¸¸å¤„ç†æœºåˆ¶
- å¯é çš„å¾®ä¿¡ç­¾åéªŒè¯åŠŸèƒ½
- å·¥å…·ç±»æä¾›äº†å®Œæ•´çš„æ—¥å¿—è®°å½•
- ä»£ç ç»“æ„æ¸…æ™°ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•


